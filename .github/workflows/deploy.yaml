name: Deploy to Kubernetes cluster

on:
  workflow_run:
    workflows: ["Build Docker image"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Kubernetes CLI
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Setup Kube config
        uses: Azure/k8s-set-context@v1
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}
      - name: Load Secrets from prod.env
        env:
          PROD_ENV: ${{ secrets.PROD_ENV }}
          PROD_SECRETS_ENV: ${{ secrets.PROD_SECRETS_ENV }}
          PATH: ${{ vars.PRODUCTION_MANIFEST_PATH }}
        run: |
          echo "$PROD_ENV" > $PATH/prod.env
          echo "$PROD_SECRETS_ENV" > $PATH/prod.secrets.env

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
        shell: bash

      - name: Deploy to production
        env:
          MANIFEST_PATH: ${{ vars.PRODUCTION_MANIFEST_PATH }}
        run: |
          kubectl apply -k $GITHUB_WORKSPACE/$MANIFEST_PATH
